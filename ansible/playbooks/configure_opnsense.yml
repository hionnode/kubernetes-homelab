---
- name: Configure OPNsense
  hosts: opnsense
  connection: local
  gather_facts: false
  vars:
    do_apply: true
    # Define the firewall dictionary required by ansibleguy modules
    # Note: ansibleguy expects 'ip', not 'url'.
    opnsense_connection:
      ip: "{{ opnsense_url | regex_replace('^https?://', '') }}"
      api_key: "{{ opnsense_api_key }}"
      api_secret: "{{ opnsense_api_secret }}"
      ssl_verify: "{{ opnsense_ssl_verify | default(false) }}"

  tasks:
    - name: Create Kubernetes VLAN 10
      ansibleguy.opnsense.interface_vlan:
        firewall: "{{ opnsense_connection }}"
        device: vlan0.10
        tag: 10
        interface: vtnet1
        description: "Kubernetes Cluster VLAN"
        state: present

    - name: Assign VLAN 10 to Interface (KUBE_NET)
      puzzle.opnsense.interfaces_assignments:
        interfaces:
          opt1: "vlan0.10"
        state: present
    
    # ... (Direct API for IP) ...
    
    - name: Enable KUBE_NET (opt1) and set IP
      uri:
        # ... (URI module uses individual vars, no change needed) ...
        url: "{{ opnsense_url }}/api/interfaces/interfaces/set"
        method: POST
        user: "{{ opnsense_api_key }}"
        password: "{{ opnsense_api_secret }}"
        body_format: json
        body:
          id: "opt1"
          enable: "1"
          ipaddr: "192.168.10.1"
          subnet: "24"
          description: "KUBE_NET"
          if: "opt1"
        validate_certs: "{{ opnsense_ssl_verify | default(false) }}"
        status_code: 200
      register: interface_set
      ignore_errors: yes

    - name: Configure DHCP for KUBE_NET
      ansibleguy.opnsense.dhcp_subnet:
        firewall: "{{ opnsense_connection }}"
        interface: "opt1"
        enabled: true
        range_from: "192.168.10.100"
        range_to: "192.168.10.200"
        dns_servers: ["1.1.1.1", "8.8.8.8"]
        gateway: "192.168.10.1"
        state: present

    # - name: Setup Firewall Rule (Allow All on KUBE_NET for now)
    #   ansibleguy.opnsense.firewall_rule:
    #     interface: ["opt1"]
    #     description: "Allow All Kube Net"
    #     action: "pass"
    #     direction: "in"
    #     protocol: "any"
    #     source: "any"
    #     destination: "any"
    #     state: present
