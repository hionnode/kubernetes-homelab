# Homelab Architecture Diagrams

ASCII network diagrams for the Kubernetes homelab infrastructure.

---

## Physical Network Topology

```
                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                         INTERNET                                │
                                    └─────────────────────────────────┬───────────────────────────────┘
                                                                      │
                                                                      │ WAN
                                                                      ▼
                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                    MAIN ROUTER (192.168.1.1)                    │
                                    │                        ISP Gateway                              │
                                    └──────────────┬──────────────────────────────┬───────────────────┘
                                                   │                              │
                                                   │ 192.168.1.110                │ 192.168.1.x (DHCP)
                                                   │                              │
                    ┌──────────────────────────────┴──────────────────────────────┴───────────────────┐
                    │                                                                                  │
                    │                          PROXMOX HOST (Mini PC)                                  │
                    │                                                                                  │
                    │   ┌────────────────────────────────┐    ┌────────────────────────────────┐      │
                    │   │         enp2s0 (WAN)           │    │    enx1c860b363f63 (LAN)       │      │
                    │   │              │                 │    │              │                 │      │
                    │   │          vmbr0                 │    │          vmbr1                 │      │
                    │   └──────────────┼─────────────────┘    └──────────────┼─────────────────┘      │
                    │                  │                                     │                        │
                    │   ┌──────────────┴─────────────────────────────────────┴───────────────────┐    │
                    │   │                                                                         │    │
                    │   │                      OPNSENSE VM (ID: 101)                              │    │
                    │   │                        6GB RAM | 2 Cores                                │    │
                    │   │                                                                         │    │
                    │   │   ┌─────────────────┐                  ┌─────────────────┐             │    │
                    │   │   │ vtnet0 (WAN)    │                  │ vtnet1 (LAN)    │             │    │
                    │   │   │ 192.168.1.x     │                  │ 10.0.0.1/24     │             │    │
                    │   │   └─────────────────┘                  └─────────────────┘             │    │
                    │   │                                                 │                       │    │
                    │   │                                          DHCP Server                    │    │
                    │   │                                       10.0.0.100-200                    │    │
                    │   │                                                                         │    │
                    │   └─────────────────────────────────────────────────────────────────────────┘    │
                    │                                                                                  │
                    │   ┌─────────────────────────────────────────────────────────────────────────┐    │
                    │   │                       TALOS VM (ID: 200)                                │    │
                    │   │                   talos-cp-1 | 10.0.0.10                                │    │
                    │   │                    4GB RAM | 2 Cores                                    │    │
                    │   └─────────────────────────────────────────────────────────────────────────┘    │
                    │                                                                                  │
                    └──────────────────────────────────────────────────────────────────────────────────┘
                                                                      │
                                                                      │ Physical Cable
                                                                      ▼
                    ┌──────────────────────────────────────────────────────────────────────────────────┐
                    │                            TP-LINK MANAGED SWITCH                                │
                    │                                                                                  │
                    │   Port 1      Port 2      Port 3      Port 4      Port 5      Port 6    ...     │
                    │     │           │           │           │           │           │               │
                    └─────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────────┘
                          │           │           │           │           │           │
                          │           │           │           │           │           │
                          ▼           ▼           ▼           ▼           ▼           ▼
                    ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
                    │Proxmox │ │talos-   │ │talos-   │ │talos-   │ │talos-   │ │talos-   │
                    │  LAN   │ │ cp-2    │ │ cp-3    │ │worker-1 │ │worker-2 │ │worker-3 │
                    │        │ │10.0.0.11│ │10.0.0.12│ │10.0.0.20│ │10.0.0.21│ │10.0.0.22│
                    └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘
                                   │           │
                                   └─────┬─────┘
                                         │
                                    Physical Mini PCs
                                   (Control Planes)
```

---

## Logical Network Layout

```
    ┌─────────────────────────────────────────────────────────────────────────────────────┐
    │                              EXTERNAL NETWORK (WAN)                                  │
    │                                  192.168.1.0/24                                      │
    │                                                                                      │
    │   ┌───────────────┐                                      ┌───────────────────────┐  │
    │   │ Main Router   │◄────────────────────────────────────►│ Proxmox Management    │  │
    │   │ 192.168.1.1   │                                      │ 192.168.1.110         │  │
    │   │   (Gateway)   │                                      │                       │  │
    │   └───────┬───────┘                                      └───────────────────────┘  │
    │           │                                                                          │
    │           │ DHCP                                                                     │
    │           ▼                                                                          │
    │   ┌───────────────┐                                                                  │
    │   │ OPNsense WAN  │                                                                  │
    │   │ 192.168.1.x   │                                                                  │
    │   └───────┬───────┘                                                                  │
    └───────────┼──────────────────────────────────────────────────────────────────────────┘
                │
                │ NAT / Firewall
                ▼
    ┌───────────────────────────────────────────────────────────────────────────────────────┐
    │                              INTERNAL NETWORK (LAN)                                    │
    │                                  10.0.0.0/24                                           │
    │                                                                                        │
    │   ┌─────────────────────────────────────────────────────────────────────────────────┐ │
    │   │                              OPNsense LAN: 10.0.0.1                              │ │
    │   │                           Gateway + DHCP + DNS                                   │ │
    │   └─────────────────────────────────────────────────────────────────────────────────┘ │
    │                                          │                                             │
    │           ┌──────────────────────────────┼──────────────────────────────┐             │
    │           │                              │                              │             │
    │           ▼                              ▼                              ▼             │
    │   ┌───────────────┐              ┌───────────────┐              ┌───────────────┐    │
    │   │   RESERVED    │              │  KUBERNETES   │              │     DHCP      │    │
    │   │  10.0.0.2-9   │              │   CLUSTER     │              │     POOL      │    │
    │   │               │              │ 10.0.0.10-49  │              │10.0.0.100-200 │    │
    │   └───────────────┘              └───────────────┘              └───────────────┘    │
    │                                          │                                            │
    │                     ┌────────────────────┼────────────────────┐                       │
    │                     │                    │                    │                       │
    │                     ▼                    ▼                    ▼                       │
    │           ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
    │           │ CONTROL PLANES  │  │    WORKERS      │  │    METALLB      │              │
    │           │ 10.0.0.10-12    │  │  10.0.0.20-22   │  │  10.0.0.50-99   │              │
    │           │                 │  │                 │  │  (LoadBalancer) │              │
    │           └─────────────────┘  └─────────────────┘  └─────────────────┘              │
    │                                                                                       │
    └───────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Kubernetes Cluster Architecture

```
                              ┌─────────────────────────────────────┐
                              │        KUBERNETES API VIP           │
                              │            10.0.0.5:6443             │
                              │     (Floating IP for HA access)     │
                              └──────────────────┬──────────────────┘
                                                 │
                    ┌────────────────────────────┼────────────────────────────┐
                    │                            │                            │
                    ▼                            ▼                            ▼
    ┌───────────────────────────┐ ┌───────────────────────────┐ ┌───────────────────────────┐
    │      CONTROL PLANE 1      │ │      CONTROL PLANE 2      │ │      CONTROL PLANE 3      │
    │        talos-cp-1         │ │        talos-cp-2         │ │        talos-cp-3         │
    │        10.0.0.10          │ │        10.0.0.11          │ │        10.0.0.12          │
    │         (Proxmox VM)      │ │       (Physical)          │ │       (Physical)          │
    │                           │ │                           │ │                           │
    │  ┌─────────────────────┐  │ │  ┌─────────────────────┐  │ │  ┌─────────────────────┐  │
    │  │ kube-apiserver      │  │ │  │ kube-apiserver      │  │ │  │ kube-apiserver      │  │
    │  │ kube-controller-mgr │  │ │  │ kube-controller-mgr │  │ │  │ kube-controller-mgr │  │
    │  │ kube-scheduler      │  │ │  │ kube-scheduler      │  │ │  │ kube-scheduler      │  │
    │  │ etcd                │◄─┼─┼──│ etcd                │◄─┼─┼──│ etcd                │  │
    │  └─────────────────────┘  │ │  └─────────────────────┘  │ │  └─────────────────────┘  │
    └───────────────────────────┘ └───────────────────────────┘ └───────────────────────────┘
                                                 │
                                                 │ Cluster Network
                                                 │
    ┌────────────────────────────┬───────────────┴───────────────┬────────────────────────────┐
    │                            │                               │                            │
    ▼                            ▼                               ▼                            │
    ┌───────────────────────────┐ ┌───────────────────────────┐ ┌───────────────────────────┐ │
    │        WORKER 1           │ │        WORKER 2           │ │        WORKER 3           │ │
    │      talos-worker-1       │ │      talos-worker-2       │ │      talos-worker-3       │ │
    │        10.0.0.20          │ │        10.0.0.21          │ │        10.0.0.22          │ │
    │       (Physical)          │ │       (Physical)          │ │       (Physical)          │ │
    │                           │ │                           │ │                           │ │
    │  ┌─────────────────────┐  │ │  ┌─────────────────────┐  │ │  ┌─────────────────────┐  │ │
    │  │ kubelet             │  │ │  │ kubelet             │  │ │  │ kubelet             │  │ │
    │  │ containerd          │  │ │  │ containerd          │  │ │  │ containerd          │  │ │
    │  │ cilium-agent        │  │ │  │ cilium-agent        │  │ │  │ cilium-agent        │  │ │
    │  │                     │  │ │  │                     │  │ │  │                     │  │ │
    │  │  ┌───────────────┐  │  │ │  │  ┌───────────────┐  │  │ │  │  ┌───────────────┐  │  │ │
    │  │  │   PODS        │  │  │ │  │  │   PODS        │  │  │ │  │  │   PODS        │  │  │ │
    │  │  │  (workloads)  │  │  │ │  │  │  (workloads)  │  │  │ │  │  │  (workloads)  │  │  │ │
    │  │  └───────────────┘  │  │ │  │  └───────────────┘  │  │ │  │  └───────────────┘  │  │ │
    │  └─────────────────────┘  │ │  └─────────────────────┘  │ │  └─────────────────────┘  │ │
    └───────────────────────────┘ └───────────────────────────┘ └───────────────────────────┘ │
                                                                                              │
    ┌─────────────────────────────────────────────────────────────────────────────────────────┘
    │
    │  CLUSTER COMPONENTS
    │
    │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
    │  │    Cilium      │  │   MetalLB      │  │  CoreDNS       │  │  Metrics       │
    │  │   (CNI)        │  │ (LoadBalancer) │  │   (DNS)        │  │  Server        │
    │  │                │  │ 10.0.0.50-99   │  │                │  │                │
    │  └────────────────┘  └────────────────┘  └────────────────┘  └────────────────┘
```

---

## Data Flow: Pod to Internet

```
    ┌─────────────────────────────────────────────────────────────────────────────────────┐
    │                                    WORKER NODE                                       │
    │                                                                                      │
    │   ┌───────────────────┐                                                             │
    │   │       POD         │                                                             │
    │   │   10.244.x.x      │  ─────►  Request to 8.8.8.8                                 │
    │   └─────────┬─────────┘                                                             │
    │             │                                                                        │
    │             ▼                                                                        │
    │   ┌───────────────────┐                                                             │
    │   │  Cilium (CNI)     │  Routes pod traffic                                         │
    │   └─────────┬─────────┘                                                             │
    │             │                                                                        │
    └─────────────┼────────────────────────────────────────────────────────────────────────┘
                  │
                  │ 10.0.0.2x → 10.0.0.1
                  ▼
    ┌─────────────────────────────────────────────────────────────────────────────────────┐
    │                                    OPNSENSE                                          │
    │                                                                                      │
    │   ┌───────────────────┐         ┌───────────────────┐         ┌───────────────────┐ │
    │   │   LAN Interface   │ ──────► │    Firewall       │ ──────► │   NAT (SNAT)      │ │
    │   │    10.0.0.1       │         │   (Allow LAN)     │         │ 10.0.0.x → WAN IP │ │
    │   └───────────────────┘         └───────────────────┘         └─────────┬─────────┘ │
    │                                                                         │           │
    │                                                                         ▼           │
    │                                                               ┌───────────────────┐ │
    │                                                               │   WAN Interface   │ │
    │                                                               │   192.168.1.x     │ │
    │                                                               └─────────┬─────────┘ │
    └─────────────────────────────────────────────────────────────────────────┼───────────┘
                                                                              │
                                                                              ▼
    ┌─────────────────────────────────────────────────────────────────────────────────────┐
    │                                   MAIN ROUTER                                        │
    │                                   192.168.1.1                                        │
    │                                                                                      │
    │   ┌───────────────────┐         ┌───────────────────┐                               │
    │   │      NAT          │ ──────► │     Internet      │ ──────► 8.8.8.8               │
    │   │ 192.168.1.x → WAN │         │                   │                               │
    │   └───────────────────┘         └───────────────────┘                               │
    └─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## IP Address Allocation

```
    ┌─────────────────────────────────────────────────────────────────────────────────────┐
    │                           10.0.0.0/24 - LAN Network                                  │
    ├─────────────────────────────────────────────────────────────────────────────────────┤
    │                                                                                      │
    │   10.0.0.1      ─────►  OPNsense Gateway / DHCP / DNS                              │
    │                                                                                      │
    │   ─────────────────────────────────────────────────────────────────────────────     │
    │                                                                                      │
    │   10.0.0.2-9    ─────►  Reserved (future infrastructure)                            │
    │                                                                                      │
    │   ─────────────────────────────────────────────────────────────────────────────     │
    │                                                                                      │
    │   10.0.0.5      ─────►  Kubernetes API VIP (HA endpoint)                            │
    │                                                                                      │
    │   ─────────────────────────────────────────────────────────────────────────────     │
    │                                                                                      │
    │   10.0.0.10     ─────►  talos-cp-1     (Control Plane - VM)                         │
    │   10.0.0.11     ─────►  talos-cp-2     (Control Plane - Physical)                   │
    │   10.0.0.12     ─────►  talos-cp-3     (Control Plane - Physical)                   │
    │                                                                                      │
    │   ─────────────────────────────────────────────────────────────────────────────     │
    │                                                                                      │
    │   10.0.0.20     ─────►  talos-worker-1 (Worker - Physical)                          │
    │   10.0.0.21     ─────►  talos-worker-2 (Worker - Physical)                          │
    │   10.0.0.22     ─────►  talos-worker-3 (Worker - Physical)                          │
    │                                                                                      │
    │   ─────────────────────────────────────────────────────────────────────────────     │
    │                                                                                      │
    │   10.0.0.50-99  ─────►  MetalLB Pool (LoadBalancer IPs)                             │
    │                                                                                      │
    │   ─────────────────────────────────────────────────────────────────────────────     │
    │                                                                                      │
    │   10.0.0.100-200 ────►  DHCP Pool (dynamic assignments)                             │
    │                                                                                      │
    └─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Quick Reference

| Component | IP / Range | Purpose |
|-----------|------------|---------|
| Main Router | 192.168.1.1 | ISP Gateway |
| Proxmox | 192.168.1.110 | Hypervisor management |
| OPNsense WAN | 192.168.1.x | Receives DHCP from main router |
| OPNsense LAN | 10.0.0.1 | Internal gateway |
| K8s API VIP | 10.0.0.5 | HA API endpoint |
| Control Planes | 10.0.0.10-12 | Kubernetes masters |
| Workers | 10.0.0.20-22 | Kubernetes workers |
| MetalLB | 10.0.0.50-99 | LoadBalancer IPs |
| DHCP Pool | 10.0.0.100-200 | Dynamic clients |
